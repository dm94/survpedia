---
import { getLangFromUrl, useTranslations } from '@i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const searchPlaceholder = t('search.placeholder');
const searchNoResults = t('search.noResults');
---

<div id="search-container" class="relative group">
  <div
    id="search-trigger"
    class="flex items-center space-x-2 cursor-pointer bg-slate-100 dark:bg-slate-800 px-3 py-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-4 w-4 text-slate-500"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
    <span class="text-sm text-slate-500">{t('nav.search')}</span>
  </div>

  <div
    id="pagefind-ui"
    class="absolute right-0 top-12 w-[80vw] md:w-96 bg-white dark:bg-slate-900 shadow-2xl rounded-xl p-4 hidden border border-slate-200 dark:border-slate-700 z-[100]"
  >
  </div>
</div>

<script>
  // Dynamic import only works if files exist, which they don't in dev until built
  // So we rely on the build step to put them in /pagefind/
</script>

<!-- Only load in production or if file exists (can't check easily here) -->
<!-- We will assume they are available at root /pagefind/ -->
<link href="/pagefind/pagefind-ui.css" rel="stylesheet" />
<script src="/pagefind/pagefind-ui.js" is:inline></script>

<script define:vars={{ lang, searchPlaceholder, searchNoResults }}>
  window.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('pagefind-ui');
    const trigger = document.getElementById('search-trigger');
    let initialized = false;

    const initSearch = () => {
      if (initialized) return;
      // @ts-ignore
      if (typeof PagefindUI !== 'undefined') {
        // @ts-ignore
        new PagefindUI({
          element: '#pagefind-ui',
          showSubResults: true,
          resetStyles: false,
          translations: {
            placeholder: searchPlaceholder,
            zero_results: searchNoResults,
          },
        });
        initialized = true;
      } else {
        console.warn(
          'PagefindUI not found. Search is only available after build.'
        );
        container.innerHTML =
          '<p class="text-sm text-red-500 p-2">Search available in production build.</p>';
      }
    };

    trigger?.addEventListener('click', () => {
      container?.classList.toggle('hidden');
      initSearch();
      // Focus input if possible
      setTimeout(() => {
        const input = container?.querySelector('input');
        if (input) input.focus();
      }, 100);
    });

    document.addEventListener('click', e => {
      if (!container?.contains(e.target) && !trigger?.contains(e.target)) {
        container?.classList.add('hidden');
      }
    });
  });
</script>

<style is:global>
  :root {
    --pagefind-ui-scale: 0.8;
    --pagefind-ui-primary: #3b82f6;
    --pagefind-ui-text: #1e293b;
    --pagefind-ui-background: #ffffff;
    --pagefind-ui-border: #e2e8f0;
    --pagefind-ui-tag: #e2e8f0;
    --pagefind-ui-font: inherit;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --pagefind-ui-text: #f1f5f9;
      --pagefind-ui-background: #0f172a;
      --pagefind-ui-border: #334155;
      --pagefind-ui-tag: #334155;
    }
  }

  .pagefind-ui__result {
    @apply border-b border-slate-100 dark:border-slate-800 !important;
  }
  .pagefind-ui__result-thumb {
    display: none !important; /* Hide thumbs for cleaner look */
  }
</style>
